/**
 * @module file-send
 * @author nuintun
 * @license MIT
 * @version 3.0.5
 * @description A http file send
 * @see https://nuintun.github.io/file-send
 */
"use strict";var fs=require("fs"),http=require("http"),Stream=require("stream"),Events=require("events"),mime=require("mime-types"),path=require("path"),ms=require("ms"),etag=require("etag"),fresh=require("fresh"),destroy=require("destroy"),encodeUrl=require("encodeurl"),micromatch=require("micromatch"),escapeHtml=require("escape-html"),parseRange=require("range-parser");const toString=Object.prototype.toString,CHARS="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),undef=void 0;function typeIs(e,t){if("array"===(t=(t+"").toLowerCase()))return Array.isArray(e);const s=toString.call(e).toLowerCase();switch(t){case"nan":return"[object number]"===s&&e!=e;default:return s==="[object "+t+"]"}}function isOutBound(e,t){return e=path.relative(t,e),!!/\.\.(?:[\\/]|$)/.test(e)}function normalize(e){let t=e=(e=(e=(e=e.replace(/\\/g,"/")).replace(/:\/{3,}/,"://")).replace(/\/\.\//g,"/")).replace(/(^|[^:])\/{2,}/g,"$1/");const s=/([^/]+)\/\.\.(?:\/|$)/g;for(;;){if(e===(t=t.replace(s,(e,t)=>".."===t?e:"")))break;e=t}return e}function posixURI(e){return e.replace(/\\/g,"/")}function decodeURI(e){try{return decodeURIComponent(e)}catch(e){return-1}}function boundaryGenerator(){let e="";for(let t=0;t<38;t++)e+=CHARS[Math.floor(62*Math.random())];return e}function parseHttpDate(e){const t=e&&Date.parse(e);return typeIs(t,"number")?t:NaN}function isUndefined(e){return e===undef}function pipeline(e){let t=0,s=e[t++];const r=e.length;for(;t<r;){let r=e[t++];s.once("error",e=>{r.emit("error",e)}),s=s.pipe(r)}return s}function parseTokenList(e){let t=0,s=[],r=0;for(let n=0,i=e.length;n<i;n++)switch(e.charCodeAt(n)){case 32:r===t&&(r=t=n+1);break;case 44:s.push(e.substring(r,t)),r=t=n+1;break;default:t=n+1}return s.push(e.substring(r,t)),s}function createErrorDocument(e,t){return'<!DOCTYPE html>\n<html>\n  <head>\n    <meta name="renderer" content="webkit" />\n    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />\n    <meta content="text/html; charset=utf-8" http-equiv="content-type" />\n'+`    <title>${e}</title>\n`+'    <style>\n      html, body, div, p {\n        text-align: center;\n        margin: 0; padding: 0;\n        font-family: Calibri, "Lucida Console", Consolas, "Liberation Mono", Menlo, Courier, monospace;\n      }\n      body { padding-top: 88px; }\n      p { color: #0e90d2; line-height: 100%; }\n      .ui-code { font-size: 200px; font-weight: bold; }\n      .ui-message { font-size: 80px; }\n    </style>\n  </head>\n  <body>\n'+`    <p class="ui-code">${e}</p>\n`+`    <p class="ui-message">${t}</p>\n`+"  </body>\n</html>\n"}const dir=Symbol("dir"),etag$1=Symbol("etag"),path$1=Symbol("path"),root=Symbol("root"),glob=Symbol("glob"),stdin=Symbol("stdin"),error=Symbol("error"),index=Symbol("index"),ignore=Symbol("ignore"),maxAge=Symbol("maxAge"),charset=Symbol("charset"),request=Symbol("request"),isFresh=Symbol("isFresh"),realpath=Symbol("realpath"),response=Symbol("response"),isIgnore=Symbol("isIgnore"),sendFile=Symbol("sendFile"),immutable=Symbol("immutable"),sendIndex=Symbol("sendIndex"),bootstrap=Symbol("bootstrap"),statError=Symbol("statError"),isCachable=Symbol("isCachable"),parseRange$1=Symbol("parseRange"),initHeaders=Symbol("initHeaders"),responseEnd=Symbol("responseEnd"),headersSent=Symbol("headersSent"),middlewares=Symbol("middlewares"),isRangeFresh=Symbol("isRangeFresh"),ignoreAccess=Symbol("ignoreAccess"),acceptRanges=Symbol("acceptRanges"),cacheControl=Symbol("cacheControl"),lastModified=Symbol("lastModified"),hasTrailingSlash=Symbol("hasTrailingSlash"),isConditionalGET=Symbol("isConditionalGET"),isPreconditionFailure=Symbol("isPreconditionFailure"),CWD=process.cwd(),MAX_MAX_AGE=31536e3;function normalizeCharset(e){return e&&typeIs(e,"string")?e:null}function normalizeRoot(e){return posixURI(typeIs(e,"string")?path.resolve(e):CWD)}function normalizePath(e){return-1===(e=decodeURI(e))?e:normalize(e)}function normalizeRealpath(e,t){return-1===t?t:posixURI(path.join(e,t))}function normalizeList(e){return(e=Array.isArray(e)?e:[e]).filter(e=>e&&typeIs(e,"string"))}function normalizeAccess(e){return"ignore"===e?e:"deny"}function normalizeMaxAge(e){return e=typeIs(e,"string")?ms(e)/1e3:Number(e),e=isNaN(e)?0:Math.min(Math.max(0,e),MAX_MAX_AGE),Math.floor(e)}function normalizeBoolean(e,t){return isUndefined(e)?t:Boolean(e)}function normalizeGlob(e){return(e=e||{}).dot=normalizeBoolean(e.dot,!0),e}class Iterator{constructor(e){this.index=0,this.array=Array.isArray(e)?e:[]}next(){const e=this.index>=this.array.length,t=e?void 0:this.array[this.index++];return{done:e,value:t}}}function series(e,t,s){!function e(r){const n=r.next();n.done?s():t(n.value,()=>{e(r)},r.index)}(new Iterator(e))}class DestroyableTransform extends Stream.Transform{constructor(e){super(e),this._destroyed=!1}destroy(e){this._destroyed||(this._destroyed=!0,process.nextTick(()=>{e&&this.emit("error",e),this.emit("close")}))}}function noop(e,t,s){s(null,e)}function through(e,t,s){typeIs(e,"function")&&(s=t,t=e,e={}),(e=e||{}).objectMode=e.objectMode||!1,e.highWaterMark=e.highWaterMark||16,typeIs(t,"function")||(t=noop),typeIs(s,"function")||(s=null);const r=new DestroyableTransform(e);return r._transform=t,s&&(r._flush=s),r}const NOT_FOUND=["ENOENT","ENAMETOOLONG","ENOTDIR"];class FileSend extends Events{constructor(e,t,s){if(!(e instanceof http.IncomingMessage))throw new TypeError("The param request must be a http request.");if(!typeIs(t,"string"))throw new TypeError("The param path must be a string.");super(s),this.path=t,this.root=s.root,this.index=s.index,this.ignore=s.ignore,this.maxAge=s.maxAge,this.charset=s.charset,this.etag=s.etag,this.ignoreAccess=s.ignoreAccess,this.immutable=s.immutable,this.acceptRanges=s.acceptRanges,this.cacheControl=s.cacheControl,this.lastModified=s.lastModified,this[middlewares]=[],this[request]=e,this[stdin]=through(),this[glob]=normalizeGlob(s.glob)}get request(){return this[request]}get response(){const e=this[response];if(!e)throw new ReferenceError("Can't get http response before called pipe method.");return e}get method(){return this.request.method}set path(e){const t=this.root;e=normalizePath(e),this[path$1]=e,this[realpath]=t?normalizeRealpath(t,e):e}get path(){return this[path$1]}set root(e){const t=this.path;e=normalizeRoot(e),this[root]=e,this[realpath]=t?normalizeRealpath(e,t):e}get root(){return this[root]}get realpath(){return this[realpath]}set index(e){this[index]=normalizeList(e)}get index(){return this[index]}set ignore(e){this[ignore]=normalizeList(e)}get ignore(){return this[ignore]}set ignoreAccess(e){this[ignoreAccess]=normalizeAccess(e)}get ignoreAccess(){return this[ignoreAccess]}set maxAge(e){this[maxAge]=normalizeMaxAge(e)}get maxAge(){return this[maxAge]}set charset(e){this[charset]=normalizeCharset(e)}get charset(){return this[charset]}set etag(e){this[etag$1]=normalizeBoolean(e,!0)}get etag(){return this[etag$1]}set immutable(e){this[immutable]=normalizeBoolean(e,!1)}get immutable(){return this[immutable]}set acceptRanges(e){this[acceptRanges]=normalizeBoolean(e,!0)}get acceptRanges(){return this[acceptRanges]}set cacheControl(e){this[cacheControl]=normalizeBoolean(e,!0)}get cacheControl(){return this[cacheControl]}set lastModified(e){this[lastModified]=normalizeBoolean(e,!0)}get lastModified(){return this[lastModified]}set statusCode(e){this.response.statusCode=e}get statusCode(){return this.response.statusCode}set statusMessage(e){this.response.statusMessage=e||http.STATUS_CODES[this.statusCode]}get statusMessage(){return this.response.statusMessage}use(e){return e instanceof Stream&&this[middlewares].push(e),this}setHeader(e,t){this.response.setHeader(e,t)}getHeader(e){return this.response.getHeader(e)}removeHeader(e){this.response.removeHeader(e)}hasHeader(e){const t=this.response;return t.hasHeader?t.hasHeader(e):t.getHeader(e)!==undef}hasListeners(e){return this.listenerCount(e)>0}status(e,t){this.statusCode=e,this.statusMessage=t}redirect(e){const t=encodeUrl(e),s=`Redirecting to <a href="${t}">${escapeHtml(e)}</a>`;this.status(301),this.setHeader("Cache-Control","no-cache"),this.setHeader("Content-Type","text/html; charset=UTF-8"),this.setHeader("Content-Length",Buffer.byteLength(s)),this.setHeader("Content-Security-Policy","default-src 'self'"),this.setHeader("X-Content-Type-Options","nosniff"),this.setHeader("Location",t),this[responseEnd](s)}pipe(e,t){if(this[response])throw new RangeError("The pipe method has been called more than once.");if(!(e instanceof http.ServerResponse))throw new TypeError("The response must be a http response.");if(this[response]=e,e.headersSent)return this[headersSent](),e;e.once("error",e=>{this[statError](e)}),this[bootstrap]();const s=[this[stdin]].concat(this[middlewares]);return s.push(e),pipeline(s)}end(e,t,s){e?this[stdin].end(e,t,s):this[stdin].end()}[headersSent](){this[responseEnd]("Can't set headers after they are sent.")}[error](e,t){const s=this.response;this.status(e,t),e=this.statusCode,t=this.statusMessage;const r=new Error(t);if(r.statusCode=e,this.hasListeners("error"))this.emit("error",r,e=>{if(s.headersSent)return this[headersSent]();this[responseEnd](e)});else{if(s.headersSent)return this[headersSent]();const r=createErrorDocument(e,t);this.setHeader("Cache-Control","private"),this.setHeader("Content-Type","text/html; charset=UTF-8"),this.setHeader("Content-Length",Buffer.byteLength(r)),this.setHeader("Content-Security-Policy","default-src 'self' 'unsafe-inline'"),this.setHeader("X-Content-Type-Options","nosniff"),this[responseEnd](r)}}[statError](e){if(-1!==NOT_FOUND.indexOf(e.code))return this[error](404);this[error](500,e.message)}[hasTrailingSlash](){return"/"===this.path[this.path.length-1]}[isConditionalGET](){const e=this.request.headers;return e["if-match"]||e["if-unmodified-since"]||e["if-none-match"]||e["if-modified-since"]}[isPreconditionFailure](){const e=this.request,t=e.headers["if-match"];if(t){const e=this.getHeader("ETag");return!e||"*"!==t&&parseTokenList(t).every(t=>t!==e&&t!=="W/"+e&&"W/"+t!==e)}const s=parseHttpDate(e.headers["if-unmodified-since"]);if(!isNaN(s)){const e=parseHttpDate(this.getHeader("Last-Modified"));return isNaN(e)||e>s}return!1}[isCachable](){const e=this.statusCode;return 304===e||e>=200&&e<300}[isFresh](){return fresh(this.request.headers,{etag:this.getHeader("ETag"),"last-modified":this.getHeader("Last-Modified")})}[isRangeFresh](){const e=this.request.headers["if-range"];if(!e)return!0;if(-1!==e.indexOf('"')){const t=this.getHeader("ETag");return Boolean(t&&-1!==e.indexOf(t))}const t=this.getHeader("Last-Modified");return parseHttpDate(t)<=parseHttpDate(e)}[isIgnore](e){return this.ignore.length&&micromatch(e,this.ignore,this[glob]).length}[parseRange$1](e){const t=[],s=e.size;let r=s;if(this.acceptRanges){let e=this.request.headers.range;if(e&&this[isRangeFresh]())if(e=parseRange(s,e,{combine:!0}),Array.isArray(e)&&"bytes"===e.type)if(this.status(206),e.length>1){let n=`<${boundaryGenerator()}>`;const i=this.getHeader("Content-Type")||"application/octet-stream";this.setHeader("Content-Type",`multipart/byteranges; boundary=${n}`);const o=`${n=`\r\n--${n}`}--\r\n`;n+=`\r\nContent-Type: ${i}`,r=0,e.forEach(e=>{const i=e.start,o=e.end,a=`${n}\r\nContent-Range: bytes ${i}-${o}/${s}\r\n\r\n`;e.open=a,r+=o-i+Buffer.byteLength(a)+1,t.push(e)}),t[0].open=t[0].open.replace(/^\r\n/,""),t[t.length-1].close=o,r+=Buffer.byteLength(o)}else{const n=e[0],i=n.start,o=n.end;this.setHeader("Content-Range",`bytes ${i}-${o}/${s}`),t.push(n),r=o-i+1}else if(-1===e)return e}return this.setHeader("Content-Length",r),t.length||t.push({}),t}[dir](){this.hasListeners("dir")?this.emit("dir",this.realpath,e=>{if(this.response.headersSent)return this[headersSent]();this[responseEnd](e)}):this[error](403)}[initHeaders](e){this.response;if(this.acceptRanges&&this.setHeader("Accept-Ranges","bytes"),!this.hasHeader("Content-Type")){let e=mime.lookup(this.path);if(e){let t=this.charset;t=t?`; charset=${t}`:"",this.setHeader("Content-Type",e+t)}}if(this.cacheControl&&!this.hasHeader("Cache-Control")){let e=`public, max-age=${this.maxAge}`;this.immutable&&(e+=", immutable"),this.setHeader("Cache-Control",e)}this.lastModified&&!this.hasHeader("Last-Modified")&&this.setHeader("Last-Modified",e.mtime.toUTCString()),this.etag&&!this.hasHeader("ETag")&&this.setHeader("ETag",etag(e))}[responseEnd](e,t,s){const r=this.response;r&&(e?r.end(e,t,s):r.end()),destroy(this[stdin])}[sendIndex](){const e=this[hasTrailingSlash](),t=e?this.path:`${this.path}/`;series(this.index.map(e=>t+e),(e,t)=>{if(this[isIgnore](e))return t();fs.stat(this.root+e,(s,r)=>{if(s||!r.isFile())return t();this.redirect(posixURI(e))})},()=>{if(e)return this[dir]();this.redirect(t)})}[sendFile](e){this.response;const t=this.realpath,s=this[stdin];series(e,(e,r)=>{e.open&&s.write(e.open);const n=fs.createReadStream(t,e);n.on("error",e=>{s.emit("error",e),destroy(n)}),n.on("end",()=>{n.unpipe(s),e.close&&s.write(e.close),destroy(n)}),n.on("close",r),n.pipe(s,{end:!1})},()=>{this.end()})}[bootstrap](){const e=this.method,t=this.response,s=this.realpath;if("GET"!==e&&"HEAD"!==e)return this[error](405);if(this.status(t.statusCode||200),-1===this.path||-1!==this.path.indexOf("\0"))return this[error](400);if(isOutBound(s,this.root))return this[error](403);if(this[isIgnore](this.path))switch(this.ignoreAccess){case"deny":return this[error](403);case"ignore":return this[error](404)}fs.stat(s,(t,r)=>{if(t)return this[statError](t);if(r.isDirectory())return this[sendIndex]();if(this[hasTrailingSlash]())return this[error](404);if(this[initHeaders](r),this[isConditionalGET]()){const e=()=>{this.removeHeader("Content-Type"),this[responseEnd]()};if(this[isPreconditionFailure]())return this.status(412),e();if(this[isCachable]&&this[isFresh]())return this.status(304),e()}if("HEAD"===e)return this.setHeader("Content-Length",r.size),this[responseEnd]();const n=this[parseRange$1](r);-1===n?(this.setHeader("Content-Range",`bytes */${r.size}`),this[error](416)):(this.hasListeners("file")&&this.emit("file",s,r),this[sendFile](n))})}}FileSend.mime=mime,module.exports=FileSend;